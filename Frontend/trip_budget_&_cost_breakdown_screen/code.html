<!DOCTYPE html>

<html class="dark" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>GlobeTrotter - Trip Budget</title>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&amp;display=swap"
        rel="stylesheet" />
    <!-- Material Symbols -->
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <!-- Theme Configuration -->
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#714b67",
                        "primary-light": "#8e6382",
                        "background-dark": "#151415",
                        "glass-border": "rgba(255, 255, 255, 0.08)",
                        "glass-bg": "rgba(30, 27, 30, 0.6)",
                    },
                    fontFamily: {
                        "display": ["Plus Jakarta Sans", "sans-serif"]
                    },
                    borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "2xl": "1rem", "full": "9999px" },
                    backdropBlur: {
                        'xs': '2px',
                    }
                },
            },
        }
    </script>
    <style>
        /* Custom Utilities for Glassmorphism */
        .glass-panel {
            background: rgba(40, 35, 40, 0.4);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        .glass-panel-hover:hover {
            background: rgba(50, 45, 50, 0.5);
            border-color: rgba(255, 255, 255, 0.15);
            transition: all 0.3s ease;
        }

        .bg-gradient-orb {
            background: radial-gradient(circle, rgba(113, 75, 103, 0.25) 0%, rgba(21, 20, 21, 0) 70%);
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(113, 75, 103, 0.3);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(113, 75, 103, 0.5);
        }
    </style>
</head>

<body class="bg-background-dark text-white font-display overflow-hidden selection:bg-primary selection:text-white">
    <!-- Ambient Background Gradients -->
    <div class="fixed top-[-20%] left-[-10%] w-[50%] h-[50%] bg-gradient-orb rounded-full pointer-events-none z-0">
    </div>
    <div class="fixed bottom-[-20%] right-[-10%] w-[50%] h-[50%] bg-gradient-orb rounded-full pointer-events-none z-0">
    </div>
    <div class="relative z-10 flex h-screen w-full">
        <!-- Sidebar -->
        <aside class="w-72 flex-shrink-0 flex flex-col glass-panel border-r-0 border-y-0 border-l-0 h-full">
            <div class="p-6 flex items-center gap-3">
                <div class="relative h-10 w-10 overflow-hidden rounded-full ring-2 ring-primary/50">
                    <div class="absolute inset-0 bg-primary/20"></div>
                    <!-- User Avatar -->
                    <img alt="Profile picture of a woman smiling" class="h-full w-full object-cover"
                        data-alt="User profile picture"
                        src="https://lh3.googleusercontent.com/aida-public/AB6AXuAgShiZsp9genWEJm86FyrsAg-CpD8xucf8U1uYFM0WfpWqNIy_A27OyS12cZViCtfDRKor_8AFeEiOX4OGxU_VDjl4lkXiRo_pgp7qnsmZzfey_8ALAe-Vuga_BOoDO00SJgsHyErWTxvFQExx1CbUy4ysyM4jRohfrh9uT_F93b6Q3fN24F3-V2T1i2yQY_Z_XXZXfv2Ia16gMA85eCbVb1gYn8XcRUAPT9XWM8YNoGDWq5MIsq1yhugtODrwdGPm0QAl5VD2uGSr" />
                </div>
                <div class="flex flex-col">
                    <h1 class="text-white text-base font-bold leading-tight">GlobeTrotter</h1>
                    <p class="text-gray-400 text-xs font-medium">Premium Plan</p>
                </div>
            </div>
            <nav class="flex-1 flex flex-col gap-2 px-4 py-4 overflow-y-auto">
                <a class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:text-white hover:bg-white/5 transition-colors group"
                    href="#">
                    <span class="material-symbols-outlined group-hover:scale-110 transition-transform">dashboard</span>
                    <span class="text-sm font-medium">Dashboard</span>
                </a>
                <a class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:text-white hover:bg-white/5 transition-colors group"
                    href="#">
                    <span class="material-symbols-outlined group-hover:scale-110 transition-transform">map</span>
                    <span class="text-sm font-medium">Itinerary</span>
                </a>
                <!-- Active State -->
                <a class="flex items-center gap-3 px-4 py-3 rounded-xl bg-primary/20 border border-primary/20 text-white shadow-lg shadow-primary/10"
                    href="#">
                    <span class="material-symbols-outlined text-primary-light fill-1">account_balance_wallet</span>
                    <span class="text-sm font-bold">Budget</span>
                </a>
                <a class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:text-white hover:bg-white/5 transition-colors group"
                    href="#">
                    <span
                        class="material-symbols-outlined group-hover:scale-110 transition-transform">confirmation_number</span>
                    <span class="text-sm font-medium">Bookings</span>
                </a>
                <a class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:text-white hover:bg-white/5 transition-colors group"
                    href="#">
                    <span class="material-symbols-outlined group-hover:scale-110 transition-transform">settings</span>
                    <span class="text-sm font-medium">Settings</span>
                </a>
            </nav>
            <div class="p-6">
                <div
                    class="glass-panel p-4 rounded-xl relative overflow-hidden group cursor-pointer hover:border-primary/30 transition-colors">
                    <div class="absolute top-0 right-0 p-2 opacity-20 group-hover:opacity-40 transition-opacity">
                        <span class="material-symbols-outlined text-4xl">flight_takeoff</span>
                    </div>
                    <p class="text-xs text-gray-400 mb-1">Upcoming Trip</p>
                    <p class="text-sm font-bold text-white">Kyoto, Japan</p>
                    <p class="text-xs text-primary-light mt-1">12 days left</p>
                </div>
            </div>
        </aside>
        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden h-full">
            <!-- Header -->
            <header class="flex-shrink-0 px-8 py-6 flex flex-wrap items-end justify-between gap-4">
                <div class="flex flex-col gap-1">
                    <div class="flex items-center gap-2 text-primary-light text-sm font-medium mb-1">
                        <span class="material-symbols-outlined text-lg">arrow_back</span>
                        <span>Back to Dashboard</span>
                    </div>
                    <h1 class="text-4xl font-black text-white tracking-tight">Kyoto Trip Budget</h1>
                    <div class="flex items-center gap-2 text-gray-400 text-sm">
                        <span class="material-symbols-outlined text-lg">calendar_month</span>
                        <span>Oct 12 - Oct 24, 2023</span>
                        <span class="w-1 h-1 rounded-full bg-gray-600 mx-1"></span>
                        <span>12 Days</span>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button
                        class="glass-panel hover:bg-white/10 text-white px-4 py-2.5 rounded-lg text-sm font-bold flex items-center gap-2 transition-all">
                        <span class="material-symbols-outlined text-lg">currency_exchange</span>
                        <span>USD</span>
                    </button>
                    <button
                        class="bg-primary hover:bg-primary/90 text-white px-5 py-2.5 rounded-lg text-sm font-bold flex items-center gap-2 shadow-lg shadow-primary/20 transition-all">
                        <span class="material-symbols-outlined text-lg">download</span>
                        <span>Export Report</span>
                    </button>
                </div>
            </header>
            <!-- Scrollable Content -->
            <div class="flex-1 overflow-y-auto px-8 pb-8">
                <div class="max-w-[1200px] mx-auto flex flex-col gap-6">
                    <!-- Stats Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <!-- Total Budget -->
                        <div
                            class="glass-panel p-5 rounded-2xl flex flex-col gap-3 relative overflow-hidden group glass-panel-hover">
                            <div
                                class="absolute right-[-10px] top-[-10px] w-24 h-24 bg-primary/20 rounded-full blur-2xl group-hover:bg-primary/30 transition-all">
                            </div>
                            <div class="flex items-center justify-between z-10">
                                <p class="text-gray-400 text-sm font-medium">Total Budget</p>
                                <span
                                    class="material-symbols-outlined text-gray-500 text-xl">account_balance_wallet</span>
                            </div>
                            <div class="z-10">
                                <p id="total-budget" class="text-3xl font-bold text-white tracking-tight">--</p>
                                <div class="flex items-center gap-1 mt-1">
                                    <span
                                        class="bg-gray-700/50 text-gray-300 text-[10px] px-1.5 py-0.5 rounded uppercase font-bold tracking-wider">Fixed</span>
                                </div>
                            </div>
                        </div>
                        <!-- Current Spend -->
                        <div
                            class="glass-panel p-5 rounded-2xl flex flex-col gap-3 relative overflow-hidden group glass-panel-hover">
                            <div class="flex items-center justify-between z-10">
                                <p class="text-gray-400 text-sm font-medium">Current Spend</p>
                                <span class="material-symbols-outlined text-gray-500 text-xl">credit_card</span>
                            </div>
                            <div class="z-10">
                                <p id="current-spend" class="text-3xl font-bold text-white tracking-tight">--</p>
                                <div class="flex items-center gap-1 mt-1 text-emerald-400 text-xs font-semibold">
                                    <span class="material-symbols-outlined text-base">trending_up</span>
                                    <span id="utilization-text">--% utilized</span>
                                </div>
                            </div>
                            <!-- Progress Bar -->
                            <div class="w-full bg-gray-700/30 h-1.5 rounded-full mt-1">
                                <div id="utilization-bar" class="bg-emerald-400 h-1.5 rounded-full" style="width: 0%">
                                </div>
                            </div>
                        </div>
                        <!-- Remaining -->
                        <div
                            class="glass-panel p-5 rounded-2xl flex flex-col gap-3 relative overflow-hidden group glass-panel-hover">
                            <div class="flex items-center justify-between z-10">
                                <p class="text-gray-400 text-sm font-medium">Remaining</p>
                                <span class="material-symbols-outlined text-gray-500 text-xl">savings</span>
                            </div>
                            <div class="z-10">
                                <p id="remaining-budget" class="text-3xl font-bold text-white tracking-tight">--</p>
                                <div class="flex items-center gap-1 mt-1 text-gray-400 text-xs font-medium">
                                    <span>Safe to spend</span>
                                </div>
                            </div>
                        </div>
                        <!-- Avg Cost/Day -->
                        <div
                            class="glass-panel p-5 rounded-2xl flex flex-col gap-3 relative overflow-hidden group glass-panel-hover border-l-4 border-l-orange-500/50">
                            <div class="flex items-center justify-between z-10">
                                <p class="text-gray-400 text-sm font-medium">Avg. Cost/Day</p>
                                <span class="material-symbols-outlined text-orange-400 text-xl">warning</span>
                            </div>
                            <div class="z-10">
                                <p id="avg-daily-cost" class="text-3xl font-bold text-white tracking-tight">--</p>
                                <div class="flex items-center gap-1 mt-1 text-orange-400 text-xs font-semibold">
                                    <span class="material-symbols-outlined text-base">arrow_upward</span>
                                    <span id="daily-diff">--</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Charts Row -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Daily Trend Chart (Takes up 2/3) -->
                        <div class="lg:col-span-2 glass-panel rounded-2xl p-6 flex flex-col">
                            <div class="flex items-center justify-between mb-6">
                                <div>
                                    <h3 class="text-lg font-bold text-white">Daily Spending Trend</h3>
                                    <p class="text-sm text-gray-400">Comparing actuals vs daily budget limit ($125)</p>
                                </div>
                                <button
                                    class="p-2 rounded-lg hover:bg-white/5 text-gray-400 hover:text-white transition-colors">
                                    <span class="material-symbols-outlined">more_horiz</span>
                                </button>
                            </div>
                            <div class="flex-1 flex flex-col justify-end gap-2 min-h-[240px]">
                                <!-- Chart Area -->
                                <div id="daily-trend-chart"
                                    class="relative h-full flex items-end justify-between px-2 gap-2">
                                    <!-- Content will be injected by JS -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Breakdown Chart (Takes up 1/3) -->
                    <div class="glass-panel rounded-2xl p-6 flex flex-col">
                        <h3 class="text-lg font-bold text-white mb-6">Cost Breakdown</h3>
                        <!-- Donut Chart Simulation with CSS Conic Gradient -->
                        <div id="breakdown-chart" class="flex items-center justify-center mb-6 relative">
                            <div id="donut-gradient" class="w-48 h-48 rounded-full relative">
                                <!-- Inner hole for donut -->
                                <div
                                    class="absolute inset-4 bg-[#1e1b1e] rounded-full flex flex-col items-center justify-center z-10 shadow-inner">
                                    <p class="text-xs text-gray-400 font-medium uppercase tracking-wider">Top Spend</p>
                                    <p id="top-category-name" class="text-2xl font-black text-white">--</p>
                                    <p id="top-category-pct" class="text-sm text-primary font-bold">--%</p>
                                </div>
                            </div>
                        </div>
                        <!-- Legend / Breakdown List -->
                        <div id="breakdown-legend" class="flex flex-col gap-3 mt-auto">
                            <!-- Legend items injected by JS -->
                        </div>
                    </div>
                </div>
                <!-- Recent Transactions & Alert Section -->
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                    <!-- Transactions List -->
                    <div class="lg:col-span-3 glass-panel rounded-2xl overflow-hidden flex flex-col">
                        <div class="p-6 border-b border-glass-border flex items-center justify-between">
                            <h3 class="text-lg font-bold text-white">Recent Transactions</h3>
                            <div class="flex gap-2">
                                <button
                                    class="text-xs font-bold text-primary hover:text-white px-3 py-1.5 rounded-lg border border-primary/30 hover:bg-primary/20 transition-colors">View
                                    All</button>
                                <button
                                    class="flex items-center gap-2 bg-primary hover:bg-primary/90 text-white text-xs font-bold px-3 py-1.5 rounded-lg transition-colors shadow-lg shadow-primary/20">
                                    <span class="material-symbols-outlined text-sm">add</span>
                                    Add Expense
                                </button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm text-gray-400">
                                <thead class="bg-white/5 text-gray-200 font-semibold uppercase tracking-wider text-xs">
                                    <tr>
                                        <th class="px-6 py-4">Expense</th>
                                        <th class="px-6 py-4">Category</th>
                                        <th class="px-6 py-4">Date</th>
                                        <th class="px-6 py-4 text-right">Amount</th>
                                        <th class="px-6 py-4 w-10"></th>
                                    </tr>
                                </thead>
                                <tbody id="expenses-table-body" class="divide-y divide-white/5">
                                    <!-- Rows injected by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <!-- Alerts / Quick Actions -->
                    <div class="lg:col-span-1 flex flex-col gap-4">
                        <!-- Alert Card -->
                        <div
                            class="glass-panel p-5 rounded-2xl border-l-4 border-l-orange-500 bg-gradient-to-br from-orange-500/10 to-transparent">
                            <div class="flex items-start gap-3 mb-2">
                                <div class="bg-orange-500/20 p-2 rounded-lg text-orange-400">
                                    <span class="material-symbols-outlined">warning</span>
                                </div>
                                <div>
                                    <p class="font-bold text-white text-sm">Budget Alert</p>
                                    <p class="text-xs text-gray-400">Food category is 85% full.</p>
                                </div>
                            </div>
                            <button
                                class="w-full mt-2 text-xs font-bold text-white bg-white/10 hover:bg-white/20 py-2 rounded-lg transition-colors">Adjust
                                Limits</button>
                        </div>
                        <!-- Tip Card -->
                        <div
                            class="glass-panel p-5 rounded-2xl border-l-4 border-l-primary bg-gradient-to-br from-primary/10 to-transparent">
                            <div class="flex items-start gap-3 mb-2">
                                <div class="bg-primary/20 p-2 rounded-lg text-primary-light">
                                    <span class="material-symbols-outlined">lightbulb</span>
                                </div>
                                <div>
                                    <p class="font-bold text-white text-sm">Saving Tip</p>
                                    <p class="text-xs text-gray-400">Get the JR Pass to save on transport.</p>
                                </div>
                            </div>
                        </div>
                        <!-- Add Widget -->
                        <button
                            class="glass-panel p-5 rounded-2xl flex flex-col items-center justify-center gap-2 border-dashed border-2 border-gray-600 hover:border-primary hover:bg-primary/5 transition-all group h-full min-h-[120px]">
                            <span
                                class="material-symbols-outlined text-3xl text-gray-500 group-hover:text-primary transition-colors">add_circle</span>
                            <span
                                class="text-sm font-bold text-gray-400 group-hover:text-primary transition-colors">Connect
                                Bank</span>
                        </button>
                    </div>
                </div>
            </div>
    </div>
    </main>
    </div>
</body>
<script>
    const API_BASE = 'http://127.0.0.1:8000';
    // Get trip_id from URL or default to 1 (Assuming login via backend sets context, but for static view prototype using 1)
    const urlParams = new URLSearchParams(window.location.search);
    const TRIP_ID = urlParams.get('trip_id') || 1;
    // For demo purpose, we assume an auth token is stored or not required for GET requests if mostly public,
    // but the backend requires auth. We'll use a hardcoded helper or assume a token exists in localStorage.
    // In a real app, you'd redirect to login if no token.
    const getAuthHeaders = () => {
        const token = localStorage.getItem('access_token');
        return token ? { 'Authorization': `Bearer ${token}` } : {};
    };

    async function fetchBudget() {
        try {
            const res = await fetch(`${API_BASE}/budget/${TRIP_ID}`, { headers: getAuthHeaders() });
            if (!res.ok) {
                console.error("Failed to fetch budget");
                return;
            }
            const data = await res.json();

            // Update Stats
            document.getElementById('total-budget').textContent = `$${data.budget_limit.toLocaleString()}`;
            document.getElementById('current-spend').textContent = `$${data.total_cost.toLocaleString()}`;
            document.getElementById('remaining-budget').textContent = `$${data.remaining.toLocaleString()}`;
            document.getElementById('avg-daily-cost').textContent = `$${data.daily_average.toFixed(0)}`;

            // Utilization
            document.getElementById('utilization-text').textContent = `${data.utilization_percentage.toFixed(1)}% utilized`;
            document.getElementById('utilization-bar').style.width = `${Math.min(data.utilization_percentage, 100)}%`;

            // Daily Diff
            const diff = data.daily_average - data.daily_target;
            const diffEl = document.getElementById('daily-diff');
            if (diff > 0) {
                diffEl.textContent = `$${diff.toFixed(0)} over daily target`;
                diffEl.parentElement.className = "flex items-center gap-1 mt-1 text-orange-400 text-xs font-semibold";
            } else {
                diffEl.textContent = `$${Math.abs(diff).toFixed(0)} under daily target`;
                diffEl.parentElement.className = "flex items-center gap-1 mt-1 text-emerald-400 text-xs font-semibold";
            }

            renderBreakdown(data.breakdown);
        } catch (err) {
            console.error(err);
        }
    }

    function renderBreakdown(breakdown) {
        const categories = {
            'transport': { color: '#714b67', label: 'Transport' },
            'stay': { color: '#0bda84', label: 'Stay' },
            'food': { color: '#fa7538', label: 'Food' },
            'activities': { color: '#3b82f6', label: 'Activities' },
            'other': { color: '#64748b', label: 'Other' }
        };

        let total = 0;
        const segments = [];
        let maxVal = 0;
        let maxKey = '';

        for (const [key, value] of Object.entries(breakdown)) {
            if (value > 0) {
                total += value;
                segments.push({ key, value, color: categories[key].color });
                if (value > maxVal) {
                    maxVal = value;
                    maxKey = key;
                }
            }
        }

        // Render Donut (Conic Gradient)
        let gradientStr = '';
        let currentPct = 0;
        segments.forEach((seg, idx) => {
            const pct = (seg.value / total) * 100;
            const endPct = currentPct + pct;
            gradientStr += `${seg.color} ${currentPct}% ${endPct}%${idx < segments.length - 1 ? ', ' : ''}`;
            currentPct = endPct;
        });

        const donutEl = document.getElementById('donut-gradient');
        if (segments.length > 0) {
            donutEl.style.background = `conic-gradient(${gradientStr})`;
        } else {
            donutEl.style.background = '#333';
        }

        // Update Center Text
        if (maxKey) {
            document.getElementById('top-category-name').textContent = categories[maxKey].label;
            document.getElementById('top-category-pct').textContent = `${((maxVal / total) * 100).toFixed(0)}%`;
        }

        // Render Legend
        const legendEl = document.getElementById('breakdown-legend');
        legendEl.innerHTML = '';
        segments.forEach(seg => {
            const html = `
                <div class="flex items-center justify-between text-sm">
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full" style="background-color: ${seg.color}"></div>
                        <span class="text-gray-300">${categories[seg.key].label}</span>
                    </div>
                    <span class="font-bold text-white">$${seg.value.toLocaleString()}</span>
                </div>
             `;
            legendEl.innerHTML += html;
        });
    }

    async function fetchDailyTrend() {
        try {
            const res = await fetch(`${API_BASE}/budget/${TRIP_ID}/daily-trend`, { headers: getAuthHeaders() });
            const data = await res.json();
            const chartEl = document.getElementById('daily-trend-chart');
            // Clear existing static bars except the limit line if handled dynamically, 
            // but here we replace innerHTML so we need to re-add the limit line

            const limitLine = `
                <div class="absolute top-[${100 - ((data.budget_limit_per_day / (Math.max(...data.days.map(d => d.total), data.budget_limit_per_day) * 1.2)) * 100)}%] left-0 right-0 border-t border-dashed border-gray-500/30 flex items-center pointer-events-none z-0">
                    <span class="text-[10px] text-gray-500 bg-[#1e1b1e] px-1 absolute -top-2 left-0">Limit ($${data.budget_limit_per_day})</span>
                </div>
            `;

            let barsHtml = '';
            const maxTotal = Math.max(...data.days.map(d => d.total), data.budget_limit_per_day) * 1.2; // Headroom

            data.days.forEach(day => {
                const heightPct = (day.total / maxTotal) * 100;
                const isOver = day.over_budget;
                const barColor = isOver ? 'bg-orange-500/80 hover:bg-orange-500 shadow-[0_0_15px_rgba(249,115,22,0.3)]' : 'bg-primary/30 hover:bg-primary';

                barsHtml += `
                    <div class="flex flex-col items-center gap-2 group w-full z-10">
                        <div class="w-full max-w-[40px] ${barColor} rounded-t-lg relative transition-all cursor-pointer" style="height: ${heightPct}%">
                            <div class="opacity-0 group-hover:opacity-100 absolute -top-8 left-1/2 -translate-x-1/2 bg-gray-800 text-white text-xs py-1 px-2 rounded shadow-xl whitespace-nowrap z-20">$${day.total}</div>
                        </div>
                        <span class="text-xs ${isOver ? 'text-white font-bold' : 'text-gray-500 font-medium'}">${new Date(day.date).toLocaleDateString('en-US', { day: 'numeric', month: 'short' })}</span>
                    </div>
                `;
            });

            chartEl.innerHTML = limitLine + barsHtml;

        } catch (err) { console.error(err); }
    }

    async function fetchExpenses() {
        try {
            const res = await fetch(`${API_BASE}/trips/${TRIP_ID}/expenses`, { headers: getAuthHeaders() });
            const expenses = await res.json();
            const tbody = document.getElementById('expenses-table-body');
            tbody.innerHTML = '';

            const catIcons = {
                'transport': { icon: 'train', bg: 'bg-primary/20', text: 'text-primary-light' },
                'food': { icon: 'restaurant', bg: 'bg-orange-500/20', text: 'text-orange-400' },
                'activities': { icon: 'temple_buddhist', bg: 'bg-blue-500/20', text: 'text-blue-400' },
                'stay': { icon: 'hotel', bg: 'bg-emerald-500/20', text: 'text-emerald-400' },
                'other': { icon: 'receipt', bg: 'bg-gray-500/20', text: 'text-gray-400' }
            };

            expenses.forEach(exp => {
                const style = catIcons[exp.category] || catIcons['other'];
                const tr = `
                    <tr class="hover:bg-white/5 transition-colors group">
                        <td class="px-6 py-4 font-medium text-white flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full ${style.bg} flex items-center justify-center ${style.text}">
                                <span class="material-symbols-outlined text-sm">${style.icon}</span>
                            </div>
                            ${exp.name}
                        </td>
                        <td class="px-6 py-4 capitalize">${exp.category}</td>
                        <td class="px-6 py-4">${new Date(exp.date).toLocaleDateString()}</td>
                        <td class="px-6 py-4 text-right font-bold text-white">$${exp.amount.toFixed(2)}</td>
                        <td class="px-6 py-4 text-right">
                             <button onclick="alert('Edit feature to be implemented')" class="opacity-0 group-hover:opacity-100 text-gray-500 hover:text-white transition-opacity">
                                <span class="material-symbols-outlined text-base">edit</span>
                            </button>
                        </td>
                    </tr>
                 `;
                tbody.innerHTML += tr;
            });
        } catch (err) { console.error(err); }
    }

    // Init
    window.addEventListener('load', () => {
        fetchBudget();
        fetchDailyTrend();
        fetchExpenses();
    });
</script>

</html>